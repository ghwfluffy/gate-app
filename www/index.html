<!doctype html>
<html lang="en">
<head>
  <link rel="manifest" href="/gate/manifest.json">
  <meta name="theme-color" content="#192e75">
  <link rel="apple-touch-icon" href="/gate/static/icons/icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Ghw Gate">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="static/default.css">
  <link rel="stylesheet" href="static/control-panel.css">
  <title>Ghw Gate</title>
</head>
<body>
  <center>
    <div id="phone" class="phone android">
      <div class="control-panel">
        <img src="static/background.png"/>
        <div class="overlay">
          <div id="msg" class="msg-box"></div>
          <div id="mainGateHotspot" class="hotspot main"></div>
          <div id="leftGateHotspot" class="hotspot left"></div>
          <div id="gymGateHotspot" class="hotspot gym"></div>
        </div>
      </div>
      <div id="error"></div>
    </div>
  </center>

  <script>
    // Don't send API requests for real & use emulated phone size
    const DEBUG = false;

    // ======= HARDCODED SECRETS (be careful: this is visible to anyone who can view the page source) =======
    const WEB_API_KEY   = "%WEB_API_KEY%";
    const REFRESH_TOKEN = "%REFRESH_TOKEN%";
    // ================================================================================================

    // Remove phone div
    if (!DEBUG) {
      document.getElementById("phone").className = "";
    }

    const openDoor = async (doorId) => {
      if (DEBUG) {
        function sleep(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        }
        await sleep(5000);
        //return "Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book";
        return null;
      }

      try {
        // 1) Exchange refresh token for access token
        const tokenUrl = `https://securetoken.googleapis.com/v1/token?key=${encodeURIComponent(WEB_API_KEY)}`;

        const form = new URLSearchParams();
        form.set("grant_type", "refresh_token");
        form.set("refresh_token", REFRESH_TOKEN);

        const tokenResp = await fetch(tokenUrl, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: form.toString(),
        });

        const tokenJson = await tokenResp.json().catch(() => ({}));
        if (!tokenResp.ok) {
          // Google error shape varies; try to surface something useful
          const detail = tokenJson?.error?.message || tokenJson?.error || JSON.stringify(tokenJson);
          throw new Error(`Token request failed (${tokenResp.status}): ${detail}`);
        }

        const accessToken = tokenJson.access_token;
        if (!accessToken) throw new Error("Token response missing access_token");

        // 2) Call open endpoint with Bearer auth
        const openResp = await fetch(`https://api-v2.gatewise.com/api/v1/user/community/2524/access_point/${doorId}/open`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Accept": "application/json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({}),
        });

        const openJson = await openResp.json().catch(() => ({}));
        if (!openResp.ok) {
          const detail = openJson?.error || openJson?.message || JSON.stringify(openJson);
          throw new Error(`Open request failed (${openResp.status}): ${detail}`);
        }

        if (openJson?.status !== "ok") {
          throw new Error(`Unexpected response: ${JSON.stringify(openJson)}`);
        }
      } catch (e) {
        return e;
      }
    }

    const errEl = document.getElementById("error");
    function setErr(text) {
      const msg = text ? ((text && text.message) ? text.message : String(text)) : "";
      errEl.textContent = msg;
    }

    const msgEl = document.getElementById("msg");
    function setMsg(text, cls) {
      msgEl.className = "msg-box " + (cls || "");
      const pill = document.createElement("span");
      pill.textContent = text || "";
      msgEl.innerHTML = "";
      msgEl.appendChild(pill);

      // Reset error
      if (cls === "ok") {
        setErr("");
      }
    }

    function resetMsg() {
      setMsg("Ghw Gate App", "");
    }

    function showError(err) {
      const text = (err && err.message) ? err.message : String(err);
      setMsg(text, "err");
    }

    resetMsg();

    function bindHotspot(doorName, doorId, div, pressed) {
      const hotspot = document.getElementById(div);

      (new Image()).src = pressed;

      function setBg(element, url) {
        element.style.backgroundImage = `url("${url}")`;
      }

      function resetBg(element) {
        setBg(element, "");
      }

      hotspot.addEventListener("pointerdown", async (e) => {
        // Prevent multiple clicks
        e.preventDefault();
        const backup_events = hotspot.style.pointerEvents;
        hotspot.style.pointerEvents = "none";

        setMsg(`Opening ${doorName}`, "ok");

        // Open door
        setBg(hotspot, pressed);
        err = await openDoor(doorId);
        if (err) {
          setErr(err);
          setMsg(`Failed to open ${doorName}`);
        } else {
          setMsg(`${doorName} opened`, "ok");
        }
        resetBg(hotspot);

        // Restore clicks
        hotspot.style.pointerEvents = backup_events;
      });
    }

    bindHotspot("Right Gate", 8211, "mainGateHotspot", "static/unlock-right-pressed.png");
    bindHotspot("Left Gate", 8210, "leftGateHotspot", "static/unlock-left-pressed.png");
    bindHotspot("Gym Door", 8209, "gymGateHotspot", "static/unlock-gym-pressed.png");
  </script>
</body>
</html>
