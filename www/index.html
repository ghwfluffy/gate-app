<!doctype html>
<html lang="en">
<head>
  <link rel="manifest" href="/gate/manifest.json">
  <meta name="theme-color" content="#192e75">
  <link rel="apple-touch-icon" href="/gate/icons/icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Ghw Gate">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gate Open</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    #msg { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
    .ok { color: #0a7a0a; }
    .err { color: #b00020; }
    button {
      background: #2f2fd3; color: #fff; border: 0; border-radius: 10px;
      padding: 12px 20px; font-size: 16px; font-weight: 700; cursor: pointer;
      width: 140px;
      height: 100px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .button.success { background: #25b325; }
    .button.failed { background: #d32f2f; }
    .row { display: flex; align-items: center; gap: 12px; padding: 12px 20px; }

    .throbber { visibility: hidden; }
    .throbber.on { visibility: visible; }

    pre { background: #f6f8fa; padding: 10px; border-radius: 10px; overflow: auto; }
  </style>
</head>
<body>
  <div class="row">
    <div id="msg"></div>
  </div>

  <div class="row">
    <button class="button" id="openRight">Open Right Gate</button>
    <img class="throbber" src="cats.gif" id="throbberRight" height=100px />
  </div>
  <div class="row">
    <button class="button" id="openLeft">Open Left Gate</button>
    <img class="throbber" src="cats.gif" id="throbberLeft" height=100px />
  </div>
  <div class="row">
    <button class="button" id="openGym">Open Gym</button>
    <img class="throbber" src="flex.gif" id="throbberGym" height=100px />
  </div>

  <pre id="debug" style="display:none;"></pre>

  <script>
    // ======= HARDCODED SECRETS (be careful: this is visible to anyone who can view the page source) =======
    const WEB_API_KEY   = "%WEB_API_KEY%";
    const REFRESH_TOKEN = "%REFRESH_TOKEN%";
    // ================================================================================================

    const openRight = document.getElementById("openRight");
    const openLeft = document.getElementById("openLeft");
    const openGym = document.getElementById("openGym");

    const throbberRight = document.getElementById("throbberRight");
    const throbberLeft = document.getElementById("throbberLeft");
    const throbberGym = document.getElementById("throbberGym");

    const msgEl   = document.getElementById("msg");
    const debugEl = document.getElementById("debug");

    function setLoading(btn, throbber, isLoading) {
      btn.disabled = isLoading;
      throbber.classList.toggle("on", isLoading);
    }

    function resetSuccess(btn) {
      btn.classList.toggle("success", false);
      btn.classList.toggle("failed", false);
    }
    function setSuccess(btn, success) {
      btn.classList.toggle(success ? "success" : "failed", true);
      setTimeout(() => { resetSuccess(btn); }, 5000);
    }

    function setMsg(text, cls) {
      msgEl.className = cls || "";
      msgEl.textContent = text || "";
    }

    function resetMsg() {
      setMsg("Ghw Gate App", "");
    }

    function showError(err) {
      const text = (err && err.message) ? err.message : String(err);
      setMsg(text, "err");
    }

    resetMsg();
    function makeOpenHandler({ doorId, doorName, throbber }) {
      return async (ev) => {
        resetMsg();
        const btn = ev.currentTarget;
        setLoading(btn, throbber, true);
        resetSuccess(btn);

        try {
          // 1) Exchange refresh token for access token
          const tokenUrl = `https://securetoken.googleapis.com/v1/token?key=${encodeURIComponent(WEB_API_KEY)}`;

          const form = new URLSearchParams();
          form.set("grant_type", "refresh_token");
          form.set("refresh_token", REFRESH_TOKEN);

          const tokenResp = await fetch(tokenUrl, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: form.toString(),
          });

          const tokenJson = await tokenResp.json().catch(() => ({}));
          if (!tokenResp.ok) {
            // Google error shape varies; try to surface something useful
            const detail = tokenJson?.error?.message || tokenJson?.error || JSON.stringify(tokenJson);
            throw new Error(`Token request failed (${tokenResp.status}): ${detail}`);
          }

          const accessToken = tokenJson.access_token;
          if (!accessToken) throw new Error("Token response missing access_token");

          // 2) Call open endpoint with Bearer auth
          const openResp = await fetch(`https://api-v2.gatewise.com/api/v1/user/community/2524/access_point/${doorId}/open`, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${accessToken}`,
              "Accept": "application/json",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({}),
          });

          const openJson = await openResp.json().catch(() => ({}));
          if (!openResp.ok) {
            const detail = openJson?.error || openJson?.message || JSON.stringify(openJson);
            throw new Error(`Open request failed (${openResp.status}): ${detail}`);
          }

          if (openJson?.status === "ok") {
            setMsg(`${doorName} opened`, "ok");
            setSuccess(btn, true);
          } else {
            throw new Error(`Unexpected response: ${JSON.stringify(openJson)}`);
            setSuccess(btn, false);
          }

        } catch (e) {
          showError(e);
          setSuccess(btn, false);
        } finally {
          setLoading(btn, throbber, false);
        }
      };
    }
    openRight.addEventListener("click", makeOpenHandler({doorId: 8211, doorName: "Right gate", throbber: throbberRight}));
    openLeft.addEventListener("click", makeOpenHandler({doorId: 8210, doorName: "Left gate", throbber: throbberLeft}));
    openGym.addEventListener("click", makeOpenHandler({doorId: 8209, doorName: "Gym door", throbber: throbberGym}));
  </script>
</body>
</html>
